<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Volleyball Strategy Board</title>
    <style>
        body { margin:0; padding:20px; font-family:sans-serif; background:#f0f2f5; display:flex; flex-direction:column; align-items:center; }
        #court-container { width:90vw; max-width:600px; height:90vw; max-height:600px; background:#FFCC99; border:3px solid #333; position:relative; overflow:hidden; box-shadow:0 4px 8px rgba(0,0,0,0.1); background-image:linear-gradient(white 2px,transparent 2px),linear-gradient(90deg,white 2px,transparent 2px); background-size:100% 33.33%,50% 100%; background-position:0 33.33%; background-repeat:no-repeat; }
        #net-area { position:absolute; top:0; left:0; width:100%; height:40px; background:repeating-linear-gradient(45deg,#ddd,#ddd 5px,#fff 5px,#fff 10px); border-bottom:4px double #555; z-index:0; }
        .player { width:60px; height:60px; background:#fff; border:3px solid #007bff; border-radius:50%; position:absolute; display:flex; justify-content:center; align-items:center; font-weight:bold; color:#333; cursor:grab; user-select:none; touch-action:none; z-index:10; box-shadow:2px 2px 5px rgba(0,0,0,0.2); transition:transform .1s; }
        .player:active { transform:scale(1.05); }
        .player-label { pointer-events:none; max-width:90%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px; }
        #volleyball { width:40px; height:40px; border-radius:50%; position:absolute; top:45%; left:45%; z-index:12; cursor:grab; touch-action:none; border:2px solid #333; background:radial-gradient(circle at 30% 30%,#fff 0,#fff 40%,#f2f2f2 41%,#f2f2f2 100%),linear-gradient(60deg,#ffd54f 0 20%,transparent 21% 40%,#42a5f5 41% 60%,transparent 61% 80%,#ef5350 81% 100%); box-shadow:2px 2px 5px rgba(0,0,0,0.3); }
        #modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center; }
        #settings-modal { background:#fff; padding:25px; border-radius:12px; width:320px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .form-group { margin-bottom:15px; }
        label { font-weight:bold; display:block; margin-bottom:5px; }
        input[type=text], select { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
        button { padding:10px 20px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
        #save-btn { background:#007bff; color:#fff; }
        #cancel-btn { background:#ddd; }
        #copy-link-btn { background:#28a745; color:white; }
    </style>
</head>
<body>
    <h2>Strategy Board</h2>

    <div id="court-container">
        <div id="net-area"></div>
        <div class="player" style="top:25%; left:15%;" data-role="OH" data-name=""><span class="player-label">OH</span></div>
        <div class="player" style="top:25%; left:45%;" data-role="S" data-name=""><span class="player-label">S</span></div>
        <div class="player" style="top:25%; left:75%;" data-role="MB" data-name=""><span class="player-label">MB</span></div>
        <div class="player" style="top:60%; left:15%;" data-role="MB" data-name=""><span class="player-label">MB</span></div>
        <div class="player" style="top:60%; left:45%;" data-role="L" data-name=""><span class="player-label">L</span></div>
        <div class="player" style="top:60%; left:75%;" data-role="OH" data-name=""><span class="player-label">OH</span></div>
        <div id="volleyball"></div>
    </div>

    <div style="margin-top:15px; text-align:center;">
        <button id="copy-link-btn">Copy board link</button>
        <div style="margin-top:8px;"><input id="link-display" type="text" readonly style="width:90%; max-width:420px; padding:6px 8px; display:none;"></div>
    </div>

    <div id="modal-overlay">
        <div id="settings-modal">
            <h3>Player Settings</h3>
            <div class="form-group">
                <label for="player-name-input">Name:</label>
                <input type="text" id="player-name-input">
            </div>
            <div class="form-group">
                <label for="player-role-select">Role:</label>
                <select id="player-role-select">
                    <option value="OH">OH</option>
                    <option value="MB">MB</option>
                    <option value="S">S</option>
                    <option value="L">L</option>
                    <option value="OPP">OPP</option>
                    <option value="DS">DS</option>
                </select>
            </div>
            <div class="modal-buttons" style="text-align:right; margin-top:15px;">
                <button id="cancel-btn">Cancel</button>
                <button id="save-btn">Save</button>
            </div>
        </div>
    </div>

<script>
// === Config ===
const PUBLIC_BASE_URL = 'https://kevinshi98.github.io/Gameboard/';

// === DOM references ===
const court = document.getElementById('court-container');
const players = document.querySelectorAll('.player');
const volleyball = document.getElementById('volleyball');
const draggableItems = [...players, volleyball];

const modalOverlay = document.getElementById('modal-overlay');
const nameInput   = document.getElementById('player-name-input');
const roleSelect  = document.getElementById('player-role-select');

const saveBtn     = document.getElementById('save-btn');
const cancelBtn   = document.getElementById('cancel-btn');
const copyLinkBtn = document.getElementById('copy-link-btn');
const linkDisplay = document.getElementById('link-display');

let activePlayer = null;

// === Drag logic (pointer events) ===
let dragItem = null;
let dragPointerId = null;
let startOffsetX = 0;
let startOffsetY = 0;

function onPointerDown(e) {
    if (e.button !== undefined && e.button !== 0) return; // left-click / primary only
    dragItem = e.currentTarget;
    dragPointerId = e.pointerId;
    const r = dragItem.getBoundingClientRect();
    startOffsetX = e.clientX - r.left;
    startOffsetY = e.clientY - r.top;
    dragItem.setPointerCapture(dragPointerId);
    dragItem.style.zIndex = 100;
}

function onPointerMove(e) {
    if (!dragItem || e.pointerId !== dragPointerId) return;
    const rect = court.getBoundingClientRect();
    let x = e.clientX - rect.left - startOffsetX;
    let y = e.clientY - rect.top - startOffsetY;
    x = Math.max(0, Math.min(x, rect.width  - dragItem.offsetWidth));
    y = Math.max(0, Math.min(y, rect.height - dragItem.offsetHeight));
    dragItem.style.left = x + 'px';
    dragItem.style.top  = y + 'px';
}

function onPointerUp(e) {
    if (!dragItem || e.pointerId !== dragPointerId) return;
    dragItem.style.zIndex = 10;
    dragItem.releasePointerCapture(dragPointerId);
    dragItem = null;
    dragPointerId = null;
}

draggableItems.forEach(el => {
    el.addEventListener('pointerdown', onPointerDown);
    el.addEventListener('pointermove', onPointerMove);
    el.addEventListener('pointerup', onPointerUp);
    el.addEventListener('pointercancel', onPointerUp);
});

// === Open modal on double-click / double-tap (players only) ===
players.forEach(player => {
    // Desktop: double-click
    player.addEventListener('dblclick', () => {
        openModal(player);
    });

    // Touch: two quick taps
    player.addEventListener('pointerup', e => {
        if (e.pointerType !== 'touch') return;
        const now = Date.now();
        const last = player._lastTapTime || 0;
        if (now - last < 350) {
            openModal(player);
        }
        player._lastTapTime = now;
    });
});

// === Modal logic ===
function openModal(playerDiv) {
    activePlayer = playerDiv;
    nameInput.value = activePlayer.dataset.name || '';
    roleSelect.value = activePlayer.dataset.role || 'OH';
    modalOverlay.style.display = 'flex';
}

function closeModal() {
    modalOverlay.style.display = 'none';
    activePlayer = null;
}

saveBtn.addEventListener('click', () => {
    if (!activePlayer) return;
    const newName = nameInput.value.trim();
    const newRole = roleSelect.value;
    const labelSpan = activePlayer.querySelector('.player-label');

    activePlayer.dataset.name = newName;
    activePlayer.dataset.role = newRole;

    labelSpan.textContent = newName || newRole || labelSpan.textContent;

    closeModal();
});

cancelBtn.addEventListener('click', closeModal);

modalOverlay.addEventListener('click', e => {
    if (e.target === modalOverlay) closeModal();
});

// === Board state encode/decode (no images, just names/roles/positions) ===
function getBoardState() {
    const playerStates = Array.from(players).map(p => ({
        name: p.dataset.name || '',
        role: p.dataset.role || '',
        left: p.style.left || '',
        top:  p.style.top  || ''
    }));
    const ballState = {
        left: volleyball.style.left || '',
        top:  volleyball.style.top  || ''
    };
    return { players: playerStates, ball: ballState };
}

function applyBoardState(state) {
    if (!state || !state.players || state.players.length !== players.length) return;
    state.players.forEach((ps, idx) => {
        const p = players[idx];
        const labelSpan = p.querySelector('.player-label');
        p.dataset.name = ps.name || '';
        p.dataset.role = ps.role || '';
        if (ps.left) p.style.left = ps.left;
        if (ps.top)  p.style.top  = ps.top;
        labelSpan.textContent = ps.name || ps.role || labelSpan.textContent;
    });
    if (state.ball) {
        if (state.ball.left) volleyball.style.left = state.ball.left;
        if (state.ball.top)  volleyball.style.top  = state.ball.top;
    }
}

function encodeStateToHash() {
    const json = JSON.stringify(getBoardState());
    const encoded = btoa(encodeURIComponent(json));
    return '#board=' + encoded;
}

function decodeStateFromHash() {
    if (!location.hash.startsWith('#board=')) return null;
    const encoded = location.hash.substring(7);
    try {
        const json = decodeURIComponent(atob(encoded));
        return JSON.parse(json);
    } catch (e) {
        console.error('Failed to decode board state', e);
        return null;
    }
}

function loadBoardFromHash() {
    const state = decodeStateFromHash();
    if (state) applyBoardState(state);
}

// === Short link generation (TinyURL) ===
async function shortenURL(longURL) {
    const resp = await fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(longURL));
    if (!resp.ok) throw new Error('TinyURL failed');
    return resp.text();
}

function isHttpUrl(url) {
    return url.startsWith('http://') || url.startsWith('https://');
}

copyLinkBtn.addEventListener('click', async () => {
    const hash = encodeStateToHash();
    const runtimeBase = PUBLIC_BASE_URL || (location.origin + location.pathname);
    const baseUrl = runtimeBase.replace(/#.*/, '');
    const longURL = baseUrl + hash;
    let finalURL = longURL;

    if (isHttpUrl(baseUrl)) {
        try {
            const shortURL = await shortenURL(longURL);
            if (shortURL) finalURL = shortURL;
        } catch (e) {
            console.warn('Shortening failed, using long URL', e);
        }
    } else {
        alert('This page is not served over http/https. The link will only work properly once you upload this HTML to a website and set PUBLIC_BASE_URL.');
    }

    linkDisplay.value = finalURL;
    linkDisplay.style.display = 'inline-block';
    linkDisplay.focus();
    linkDisplay.select();
    window.prompt('Copy this link (Ctrl/Cmd+C):', finalURL);
});

// Initial load from hash if present
loadBoardFromHash();
</script>
</body>
</html>
